<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>data_ingestion/sentinel2/improve_cloud_mask &mdash; FarmVibes.AI  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/custom.css?v=85179c66" />

  
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js?v=b3ba4146"></script>
        <script src="../../../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
        <script src="https://unpkg.com/mermaid@9.4.0/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            FarmVibes.AI
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guides &amp; Tutorials:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../QUICKSTART.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../AKS.html">Remote Cluster User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../CLIENT.html">FarmVibes.AI Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../WORKFLOWS.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../NOTEBOOK_LIST.html">Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../REST_API.html">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../CACHE.html">Data Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../SECRETS.html">Secrets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../TROUBLESHOOTING.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Main Components:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../code/vibe_core_client/client.html">FarmVibes.AI Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../code/vibe_core_data/index_data_types.html">Data Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../WORKFLOW_LIST.html">Workflow List</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Supporting Components:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../code/vibe_core_client/admag_client.html">Azure Data Manager for Agriculture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../code/vibe_core_client/datamodel.html">Data Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../code/vibe_core_client/additional_modules/filedownloader.html">File Downloader</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../code/vibe_core_client/additional_modules/fileutils.html">File Utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../code/vibe_core_client/additional_modules/logconfig.html">Logconfig</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../code/vibe_core_client/additional_modules/monitor.html">Monitor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../code/vibe_core_client/additional_modules/uri.html">URI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../code/vibe_core_client/additional_modules/utils.html">Utils</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">FarmVibes.AI</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">data_ingestion/sentinel2/improve_cloud_mask</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../_sources/docfiles/markdown/workflow_yaml/data_ingestion/sentinel2/improve_cloud_mask.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="data-ingestion-sentinel2-improve-cloud-mask">
<h1>data_ingestion/sentinel2/improve_cloud_mask<a class="headerlink" href="#data-ingestion-sentinel2-improve-cloud-mask" title="Permalink to this heading"></a></h1>
<p>Improves cloud masks by merging the product cloud mask with cloud and shadow masks computed by machine learning segmentation models. This workflow computes cloud and shadow probabilities using segmentation models, thresholds them, and merges the models’ masks with the product mask.</p>
<div class="mermaid">
                graph TD
    inp1&gt;s2_raster]
    inp2&gt;product_mask]
    out1&gt;mask]
    tsk1{{cloud}}
    tsk2{{shadow}}
    tsk3{{merge}}
    tsk1{{cloud}} -- cloud_probability --&gt; tsk3{{merge}}
    tsk2{{shadow}} -- shadow_probability --&gt; tsk3{{merge}}
    inp1&gt;s2_raster] -- sentinel_raster --&gt; tsk1{{cloud}}
    inp1&gt;s2_raster] -- sentinel_raster --&gt; tsk2{{shadow}}
    inp2&gt;product_mask] -- product_mask --&gt; tsk3{{merge}}
    tsk3{{merge}} -- merged_cloud_mask --&gt; out1&gt;mask]
        </div><section id="sources">
<h2>Sources<a class="headerlink" href="#sources" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p><strong>s2_raster</strong>: Sentinel-2 L2A raster.</p></li>
<li><p><strong>product_mask</strong>: Cloud mask obtained from the product’s quality indicators.</p></li>
</ul>
</section>
<section id="sinks">
<h2>Sinks<a class="headerlink" href="#sinks" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p><strong>mask</strong>: Improved cloud mask.</p></li>
</ul>
</section>
<section id="parameters">
<h2>Parameters<a class="headerlink" href="#parameters" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p><strong>cloud_thr</strong>: Confidence threshold to assign a pixel as cloud.</p></li>
<li><p><strong>shadow_thr</strong>: Confidence threshold to assign a pixel as shadow.</p></li>
<li><p><strong>in_memory</strong>: Whether to load the whole raster in memory when running predictions. Uses more memory (~4GB/worker) but speeds up inference for fast models.</p></li>
<li><p><strong>cloud_model</strong>: ONNX file for the cloud model. Available models are ‘cloud_model{idx}_cpu.onnx’ with idx ∈ {1, 2} being FPN-based models, which are more accurate but slower, and idx ∈ {3, 4, 5} being cheaplab models, which are less accurate but faster.</p></li>
<li><p><strong>shadow_model</strong>: ONNX file for the shadow model. ‘shadow.onnx’ is the only currently available model.</p></li>
</ul>
</section>
<section id="tasks">
<h2>Tasks<a class="headerlink" href="#tasks" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p><strong>cloud</strong>: Computes cloud probabilities using a convolutional segmentation model for L2A.</p></li>
<li><p><strong>shadow</strong>: Computes shadow probabilities using a convolutional segmentation model for L2A.</p></li>
<li><p><strong>merge</strong>: Merges cloud, shadow and product cloud masks into a single mask.</p></li>
</ul>
</section>
<section id="workflow-yaml">
<h2>Workflow Yaml<a class="headerlink" href="#workflow-yaml" title="Permalink to this heading"></a></h2>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">improve_cloud_mask</span>
<span class="nt">sources</span><span class="p">:</span>
<span class="w">  </span><span class="nt">s2_raster</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloud.sentinel_raster</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">shadow.sentinel_raster</span>
<span class="w">  </span><span class="nt">product_mask</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">merge.product_mask</span>
<span class="nt">sinks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">mask</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">merge.merged_cloud_mask</span>
<span class="nt">parameters</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cloud_thr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
<span class="w">  </span><span class="nt">shadow_thr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
<span class="w">  </span><span class="nt">in_memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
<span class="w">  </span><span class="nt">cloud_model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
<span class="w">  </span><span class="nt">shadow_model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
<span class="nt">tasks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cloud</span><span class="p">:</span>
<span class="w">    </span><span class="nt">op</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">compute_cloud_prob</span>
<span class="w">    </span><span class="nt">parameters</span><span class="p">:</span>
<span class="w">      </span><span class="nt">in_memory</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;@from(in_memory)&#39;</span>
<span class="w">      </span><span class="nt">model_path</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;@from(cloud_model)&#39;</span>
<span class="w">  </span><span class="nt">shadow</span><span class="p">:</span>
<span class="w">    </span><span class="nt">op</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">compute_shadow_prob</span>
<span class="w">    </span><span class="nt">parameters</span><span class="p">:</span>
<span class="w">      </span><span class="nt">in_memory</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;@from(in_memory)&#39;</span>
<span class="w">      </span><span class="nt">model_path</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;@from(shadow_model)&#39;</span>
<span class="w">  </span><span class="nt">merge</span><span class="p">:</span>
<span class="w">    </span><span class="nt">op</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">merge_cloud_masks_simple</span>
<span class="w">    </span><span class="nt">op_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">merge_cloud_masks</span>
<span class="w">    </span><span class="nt">parameters</span><span class="p">:</span>
<span class="w">      </span><span class="nt">cloud_prob_threshold</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;@from(cloud_thr)&#39;</span>
<span class="w">      </span><span class="nt">shadow_prob_threshold</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;@from(shadow_thr)&#39;</span>
<span class="nt">edges</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">origin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloud.cloud_probability</span>
<span class="w">  </span><span class="nt">destination</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">merge.cloud_probability</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">origin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">shadow.shadow_probability</span>
<span class="w">  </span><span class="nt">destination</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">merge.shadow_probability</span>
<span class="nt">description</span><span class="p">:</span>
<span class="w">  </span><span class="nt">short_description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Improves cloud masks by merging the product cloud mask with cloud</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">and shadow masks computed by machine learning segmentation models.</span>
<span class="w">  </span><span class="nt">long_description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">This workflow computes cloud and shadow probabilities using segmentation</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">models, thresholds them, and merges the models&#39; masks with the product mask.</span>
<span class="w">  </span><span class="nt">sources</span><span class="p">:</span>
<span class="w">    </span><span class="nt">s2_raster</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Sentinel-2 L2A raster.</span>
<span class="w">    </span><span class="nt">product_mask</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Cloud mask obtained from the product&#39;s quality indicators.</span>
<span class="w">  </span><span class="nt">sinks</span><span class="p">:</span>
<span class="w">    </span><span class="nt">mask</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Improved cloud mask.</span>
<span class="w">  </span><span class="nt">parameters</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cloud_thr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Confidence threshold to assign a pixel as cloud.</span>
<span class="w">    </span><span class="nt">shadow_thr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Confidence threshold to assign a pixel as shadow.</span>
<span class="w">    </span><span class="nt">in_memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Whether to load the whole raster in memory when running predictions.</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">Uses more memory (~4GB/worker) but speeds up inference for fast models.</span>
<span class="w">    </span><span class="nt">cloud_model</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ONNX</span><span class="nv"> </span><span class="s">file</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">cloud</span><span class="nv"> </span><span class="s">model.</span><span class="nv"> </span><span class="s">Available</span><span class="nv"> </span><span class="s">models</span><span class="nv"> </span><span class="s">are</span><span class="nv"> </span><span class="s">&#39;cloud_model{idx}_cpu.onnx&#39;\</span>
<span class="w">      </span><span class="s">\ with</span><span class="nv"> </span><span class="s">idx</span><span class="nv"> </span><span class="se">\u2208</span><span class="nv"> </span><span class="s">{1,</span><span class="nv"> </span><span class="s">2}</span><span class="nv"> </span><span class="s">being</span><span class="nv"> </span><span class="s">FPN-based</span><span class="nv"> </span><span class="s">models,</span><span class="nv"> </span><span class="s">which</span><span class="nv"> </span><span class="s">are</span><span class="nv"> </span><span class="s">more</span><span class="nv"> </span><span class="s">accurate</span><span class="nv"> </span><span class="s">but\</span>
<span class="w">      </span><span class="s">\ slower,</span><span class="nv"> </span><span class="s">and</span><span class="nv"> </span><span class="s">idx</span><span class="nv"> </span><span class="se">\u2208</span><span class="nv"> </span><span class="s">{3,</span><span class="nv"> </span><span class="s">4,</span><span class="nv"> </span><span class="s">5}</span><span class="nv"> </span><span class="s">being</span><span class="nv"> </span><span class="s">cheaplab</span><span class="nv"> </span><span class="s">models,</span><span class="nv"> </span><span class="s">which</span><span class="nv"> </span><span class="s">are</span><span class="nv"> </span><span class="s">less</span><span class="nv"> </span><span class="s">accurate\</span>
<span class="w">      </span><span class="s">\ but</span><span class="nv"> </span><span class="s">faster.&quot;</span>
<span class="w">    </span><span class="nt">shadow_model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ONNX file for the shadow model. &#39;shadow.onnx&#39; is the only currently</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">available model.</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Microsoft.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>